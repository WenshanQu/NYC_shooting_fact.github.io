---
title: "COVID"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
  html_notebook:
    toc: yes
editor_options:
  chunk_output_type: inline
---
```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(dplyr)
library(viridis)
library(gganimate)
library(ggmap)
library(png)
library(gifski)
theme_set(theme_minimal() + theme(legend.position = "bottom"))

knitr::opts_chunk$set(
  fig.width = 8,
  fig.height = 6,
  out.width = "90%",
  message = FALSE,
  warning = FALSE,
  error = FALSE
)

options(
  ggplot2.continuous.color = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_color_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

```{r read, include = FALSE }
covid_19_df = read.csv("./data/covid_19_nyc.csv") %>% 
  select(year, month, day, cases) %>%
     mutate(
    month = as.factor(month), 
    day = as.factor(day), 
    year = as.factor(year)
   )

```


```{r import data, include = FALSE}
history_df = read.csv('./data/historic.csv')

year_to_date_df = read.csv('./data/year_to_date.csv') %>% 
  rename(Lon_Lat = New.Georeferenced.Column)
```

```{r data cleaning, include = FALSE}
Shooting_df = bind_rows(history_df, year_to_date_df) %>% 
  janitor::clean_names() %>% 
  separate(occur_date, c("month","day","year")) %>% 
  separate(occur_time, c("hour","minute","second")) %>% 
  mutate(
    year = as.numeric(year), 
    month = as.numeric(month),
    day = as.numeric(day),
    hour = as.numeric(hour),
    minute = as.numeric(minute)
    ) %>% 
  select(-second)
```

```{r data, include=FALSE}
shooting = Shooting_df %>% 
  select(year, month, day) %>% 
  group_by(year, month, day) %>% 
  summarise(daycount = n()) %>% 
  subset(year == 2020 | year == 2021)
subset2 = shooting %>% 
  subset(year == 2020 & month <= 2)
shooting = anti_join(shooting,subset2)

shooting_covid = merge(covid_19_df, shooting, by = c('year', 'month', 'day'), all = TRUE) %>% 
 mutate_all(~replace(., is.na(.), 0)) %>% 
 mutate(
   year = as.character(year), 
   month = as.numeric(month),
   day = as.numeric(day),
   date = lubridate::make_date(year, month, day)
   ) %>% 
  select(date, daycount, cases) %>% 
  rename(
    shooting_cases = daycount,
    covid_cum = cases
  ) %>% 
  mutate(
    date = as.factor(date)
  ) %>% 
  mutate(covid_cases = covid_cum - lag(covid_cum, default = 0, order_by = date)) %>% 
  mutate(
    shooting_cum = cumsum(shooting_cases),
    covid_cum_per1000 = covid_cum/1000
    )
  
```

## Cumulative Bar

The cumulative chart shows accumulation of both COVID-19 cases and Shooting cases in NYC county from 2020-03-01 until  2021-09-30. In order to make the plot more readable, We divided the COVID-19 cumulative cases by 1000 due to its rapid growth rate compared to shooting cases. The bar chart shows a potential peak shifting fluctuation, instead of co-frequency resonance, which may be due to the delayed effect of Covid-19 on society. Therefore, we go deeper into the relationship between the accumulation of shooting cases and COVID cases.
```{r barplot}
plot_ly(shooting_covid, x = ~date, y = ~covid_cum_per1000 , type = "bar", alpha = 1, name = "COVID cases(/1000)") %>% 
  add_trace(shooting_covid, x = ~date, y = ~shooting_cum, type = "bar", alpha = 0.6, name = "Shooting case") %>% 
  layout(
    title = "Cumulative bar for Covid and Shooting",
    barmode = "overlap",
    xaxis = list(title = "date"),
    yaxis = list(title = "cumulative scale")) %>% 
  layout(showlegend = TRUE, legend = list(font = list(size = 8)))
```

## Linear relation between accumulations

The linear plot clearly shows a steep rise in shooting cases when COVID-19 case accumulated to 200,000 around 2020-05-15 in NYC. The growth rate becomes slower for nearly half a year from around 2020-11-15, and then increases again since 2021-05, but not as rapid as in 2020. Combined with the month and shooting cases analysis before, increase in shooting case during May is common, but especially high growth rate during the begining of epidemic is unusual. What's more, it is noteworthy that the spread of Delta virus also begins in the end of April, 2021.

```{r cum_relation}
shooting_covid %>% 
  mutate(text_label = str_c("date: ", date)) %>% 
  plot_ly(x = ~covid_cum_per1000, y = ~shooting_cum,type = 'scatter', mode = 'lines', text = ~text_label, alpha = 0.8, colors = "viridis") %>% 
  layout(
    title = "Linear Relationship between Accumulations ",
    xaxis = list(title = "Cumulative covid cases/1000"),
    yaxis = list(title = "Cumulative shooting cases"))
```

